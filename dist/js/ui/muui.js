// Generated by CoffeeScript 1.7.1
define(['muui/core/utils'], function(utils) {
  var MuUI;
  MuUI = (function() {
    MuUI.defaults = {
      el: '',
      datasource: '',
      render_fn: 'replaceWith',
      data_filter: function(r) {
        return r;
      },
      before_render: function() {},
      after_render: function() {}
    };

    MuUI.prototype.get_opts = function(options) {
      return $.extend({}, MuUI.defaults, options);
    };

    function MuUI(options) {
      var opts;
      this.opts = opts = this.get_opts(options);
      if (!opts.el) {
        throw new Error('el cannot be empty.');
      }
      this.$el = $(opts.el);
      this.render().done((function(_this) {
        return function() {
          return _this.init_events();
        };
      })(this));
    }

    MuUI.prototype.get_datasource = function() {
      var datasource;
      datasource = this.opts.datasource;
      try {
        datasource = JSON.parse(datasource);
      } catch (_error) {
        datasource = this.opts.datasource;
      }
      return datasource;
    };

    MuUI.prototype.render = function() {
      var $el, after_render, before_render, def, opts, tmpl;
      $el = this.$el, opts = this.opts;
      before_render = opts.before_render, after_render = opts.after_render, tmpl = opts.tmpl;
      before_render();
      def = $.Deferred();
      if (tmpl) {
        require([tmpl], (function(_this) {
          return function(tmpl) {
            var datasource, render_fn, render_tmpl;
            render_fn = opts.render_fn;
            render_tmpl = function(r) {
              var $tmpl;
              $tmpl = $(tmpl(r));
              $el[render_fn]($tmpl);
              if (render_fn === 'replaceWith') {
                _this.$el = $tmpl;
              }
              def.resolve(r, $tmpl);
              return after_render(r, $tmpl);
            };
            datasource = _this.get_datasource();
            if (datasource) {
              return utils.api(datasource).done(function(r) {
                return render_tmpl(opts.data_filter(r));
              });
            } else {
              return render_tmpl();
            }
          };
        })(this));
      } else {
        def.resolve();
        after_render();
      }
      return def.promise();
    };

    MuUI.prototype.init_events = function() {};

    return MuUI;

  })();
  return MuUI;
});
